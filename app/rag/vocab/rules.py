
# 카드 / 정부지원 프로그램 명칭 동의어
# canonical: 내부 표준 명칭
# values: 사용자 발화에서 인식할 수 있는 다양한 표현
CARD_NAME_SYNONYMS = {
    "BC우리카드": [
        "BC우리 카드",
        "bc우리카드"
    ],
    "Gift카드": [
        "Gift 카드",
        "gift카드"
    ],
    "K-패스": [
        "K 패스",
        "K- 패스",
        "K패스",
        "k-패스",
        "k패스",
        "케이 패스",
        "케이패스"
    ],
    "e-Gift카드": [
        "e Gift카드",
        "e-Gift 카드",
        "e-gift카드",
        "eGift카드"
    ],
    "국가바우처": [
        "국가 바우처"
    ],
    "국민행복카드": [
        "국민 행복카드",
        "국민행복 카드",
        "행복카드"
    ],
    "기후동행카드": [
        "기후동행 카드"
    ],
    "나라사랑카드": [
        "나라사랑",
        "나라사랑 카드"
    ],
    "네이버페이카드": [
        "네이버 카드",
        "네이버카드",
        "네이버페이 카드"
    ],
    "농협카드": [
        "농협 카드"
    ],
    "더경기패스": [
        "더경기 패스"
    ],
    "동백패스": [
        "동백 패스"
    ],
    "민생회복 소비쿠폰": [
        "민생 회복",
        "민생 회복 소비 쿠폰",
        "민생 회복 소비쿠폰",
        "민생 회복 쿠폰",
        "민생회복",
        "민생회복 소비 쿠폰",
        "민생회복 쿠폰",
        "민생회복소비쿠폰",
        "민생회복쿠폰",
        "소비 쿠폰",
        "소비쿠폰",
        "민생 쿠폰",
        "민생쿠폰",
        "지원금 쿠폰",
        "지원쿠폰"
    ],
    "삼성앱카드": [
        "삼성앱 카드"
    ],
    "삼성카드": [
        "삼성 카드"
    ],
    "서울시다둥이행복카드": [
        "다둥이",
        "다둥이 카드",
        "다둥이 행복카드",
        "다둥이카드",
        "다자녀",
        "다자녀 카드",
        "다자녀카드",
        "서울시 다둥이 카드",
        "서울시 다둥이 행복카드",
        "서울시 다둥이카드",
        "서울시다둥이행복 카드"
    ],
    "시니어카드": [
        "시니어",
        "시니어 카드"
    ],
    "애니패스카드": [
        "애니패스 카드"
    ],
    "우리카드": [
        "우리 카드"
    ],
    "쿠팡와우카드": [
        "와우카드",
        "쿠팡 와우",
        "쿠팡 와우 카드",
        "쿠팡와우",
        "쿠팡와우 카드"
    ],
    "테디카드": [
        "테디 카드"
    ],
    "하나카드": [
        "하나 카드"
    ],
    "행복카드": [
        "행복 카드"
    ]
}

# 명확한 사용자 행동 의도
ACTION_SYNONYMS = {
    "1차 신청 대상": [
        "1차신청대상"
    ],
    "1차 신청 일시": [
        "1차신청일시"
    ],
    "2차 신청 대상": [
        "2차신청대상"
    ],
    "2차 신청 일시": [
        "2차신청일시"
    ],
    "CD ATM 자동화기기 이용 수수료": [
        "CDATM자동화기기이용수수료",
        "cd atm 자동화기기 이용 수수료"
    ],
    "CGV 할인": [
        "CGV할인",
        "cgv 할인"
    ],
    "가맹점주 안내": [
        "가맹점주안내"
    ],
    "가맹점주 안내 - VAN사 예시": [
        "가맹점주 안내 - van사 예시",
        "가맹점주 안내 VAN사 예시",
        "가맹점주안내-VAN사예시",
        "가맹점주안내VAN사예시"
    ],
    "간편인증을 통한 소득조회 및 이용안내": [
        "간편인증을통한소득조회및이용안내"
    ],
    "결제 내역이 보이지 않습니다": [
        "결제내역이보이지않습니다" 
    ],
    "결제취소": [
        "결제 취소",
        "승인 취소",
        "승인취소"
    ],
    "교보문고 할인": [
        "교보문고할인"
    ],
    "교통": [
        "교통 카드",
        "교통카드",
        "후불 교통",
        "후불교통"
    ],
    "교통 이용 안내": [
        "교통이용안내"
    ],
    "구매 취소": [
        "구매취소"
    ],
    "군 KT공중전화 할인": [
        "군 kt공중전화 할인",
        "군KT공중전화할인"
    ],
    "금융수수료 면제": [
        "금융수수료면제"
    ],
    "꼭 필요한 카드만 발급받으세요": [
        "꼭필요한카드만발급받으세요"
    ],
    "놀이공원 할인": [
        "놀이공원할인"
    ],
    "단기카드대출 현금서비스": [
        "단기카드대출현금서비스"
    ],
    "대상 가맹점에서 5 청구할인": [
        "대상가맹점에서5청구할인"
    ],
    "대중교통 할인": [
        "대중교통할인"
    ],
    "대출": [],
    "대출 계약 철회 안내": [
        "대출계약철회안내"
    ],
    "대출계약철회 안내": [
        "대출계약철회안내"
    ],
    "발급 대상": [
        "발급대상"
    ],
    "발급 안내": [
        "발급안내"
    ],
    "발급 주체에 따른 구분": [
        "발급주체에따른구분"
    ],
    "발급신청": [],
    "배송 조회": [
        "배송조회"
    ],
    "분실": [
        "도난",
        "두고 왔",
        "두고왔",
        "못 찾",
        "못 찾겠",
        "못찾",
        "못찾겠",
        "분실했",
        "분실했어",
        "분실했어요",
        "없어졌",
        "잃어버",
        "잃어버렸",
        "잃어버렸어요"
    ],
    "사용 기간": [
        "사용기간"
    ],
    "사용 불가 업종": [
        "사용불가업종"
    ],
    "사용등록소득공제 안내": [
        "사용등록소득공제안내"
    ],
    "사용처": [],
    "상환방법": [],
    "상환방법 안내": [
        "상환방법안내"
    ],
    "상환방식 안내": [
        "상환방식안내"
    ],
    "선지급포인트서비스 선포인트서비스": [
        "선지급포인트서비스선포인트서비스"
    ],
    "소득공제 등록내역 조회 취소": [
        "소득공제등록내역조회취소"
    ],
    "쇼핑 할인": [
        "쇼핑할인"
    ],
    "스타벅스 할인": [
        "스타벅스할인"
    ],
    "신용정보 알림서비스 이용 수수료": [
        "신용정보알림서비스이용수수료"
    ],
    "신청 방법 및 시간": [
        "신청방법및시간"
    ],
    "어학시험 할인": [
        "어학시험할인"
    ],
    "연체료율": [],
    "연체이자율": [],
    "연회비": [
        "연 회비"
    ],
    "연회비 반환 기준": [
        "연회비반환기준"
    ],
    "연회비반환기준": [],
    "예약 및 취소가 빈번한 일부 가맹점": [
        "예약및취소가빈번한일부가맹점"
    ],
    "외화 결제 가맹점": [
        "외화결제가맹점"
    ],
    "우량대출": [],
    "이용 불가 가맹점 안내": [
        "이용불가가맹점안내"
    ],
    "이용기간 한도": [
        "이용기간한도"
    ],
    "이용방법": [],
    "이용방법 및 결제방식 안내": [
        "이용방법및결제방식안내"
    ],
    "이용방법 안내": [
        "이용방법안내"
    ],
    "이용처 안내": [
        "이용처안내"
    ],
    "이용처 안내 - 레저 여행": [
        "이용처 안내 레저 여행",
        "이용처안내-레저여행",
        "이용처안내레저여행"
    ],
    "이용처 안내 - 마트 슈퍼": [
        "이용처 안내 마트 슈퍼",
        "이용처안내-마트슈퍼",
        "이용처안내마트슈퍼"
    ],
    "이용처 안내 - 백화점 쇼핑": [
        "이용처 안내 백화점 쇼핑",
        "이용처안내-백화점쇼핑",
        "이용처안내백화점쇼핑"
    ],
    "이용처 안내 - 생활 가전": [
        "이용처 안내 생활 가전",
        "이용처안내-생활가전",
        "이용처안내생활가전"
    ],
    "이용처 안내 - 영화 도서": [
        "이용처 안내 영화 도서",
        "이용처안내-영화도서",
        "이용처안내영화도서"
    ],
    "이용처 안내 - 온라인": [
        "이용처 안내 온라인",
        "이용처안내-온라인",
        "이용처안내온라인"
    ],
    "이용처 안내 - 외식": [
        "이용처 안내 외식",
        "이용처안내-외식",
        "이용처안내외식"
    ],
    "이용처 안내 - 제과 디저트": [
        "이용처 안내 제과 디저트",
        "이용처안내-제과디저트",
        "이용처안내제과디저트"
    ],
    "이용처 안내 - 주유 충전": [
        "이용처 안내 주유 충전",
        "이용처안내-주유충전",
        "이용처안내주유충전"
    ],
    "이용처 안내 - 커피": [
        "이용처 안내 커피",
        "이용처안내-커피",
        "이용처안내커피"
    ],
    "이용처 안내 - 패션 뷰티": [
        "이용처 안내 패션 뷰티",
        "이용처안내-패션뷰티",
        "이용처안내패션뷰티"
    ],
    "이용처 안내 - 편의점": [
        "이용처 안내 편의점",
        "이용처안내-편의점",
        "이용처안내편의점"
    ],
    "이용처 안내 - 호텔 리조트": [
        "이용처 안내 호텔 리조트",
        "이용처안내-호텔리조트",
        "이용처안내호텔리조트"
    ],
    "이자율과 수수료": [
        "이자율과수수료"
    ],
    "이자율이란": [],
    "일부결제금액이월약정 리볼빙": [
        "일부결제금액이월약정리볼빙"
    ],
    "일부결제금액이월약정 리볼빙 이자율": [
        "일부결제금액이월약정리볼빙이자율"
    ],
    "일상 생활비 적립": [
        "일상생활비적립"
    ],
    "일상 생활비 적립 서비스": [
        "일상생활비적립서비스"
    ],
    "일상 생활비 적립 서비스 추가 제외": [
        "일상생활비적립서비스추가제외"
    ],
    "자체 상품권을 발행하는 일부 가맹점": [
        "자체상품권을발행하는일부가맹점"
    ],
    "잔액 환불 안내": [
        "잔액환불안내"
    ],
    "장기카드대출 카드론": [
        "장기카드대출카드론"
    ],
    "장기카드대출 카드론 이자율": [
        "장기카드대출카드론이자율"
    ],
    "재발급": [
        "다시 발급",
        "새로 발급",
        "재발행"
    ],
    "재발급 수수료 면제 기준은": [
        "재발급수수료면제기준은"
    ],
    "재발급 안내": [
        "재발급안내"
    ],
    "저소득층 적립금액 상향 신청해지 방법": [
        "저소득층적립금액상향신청해지방법"
    ],
    "적립": [
        "포인트 적립"
    ],
    "전월 이용금액 제외대상": [
        "전월이용금액제외대상"
    ],
    "전월 이용실적 기준": [
        "전월이용실적기준"
    ],
    "전월 이용실적 제외 대상": [
        "전월이용실적제외대상"
    ],
    "주말 배달앱 포인트 적립": [
        "주말배달앱포인트적립"
    ],
    "청구할인": [
        "청구 할인"
    ],
    "체크카드 사용 시간 제한": [
        "체크카드사용시간제한"
    ],
    "취급수수료": [],
    "카드대금 납부": [
        "카드대금납부"
    ],
    "카드대출 예약신청": [
        "카드대출예약신청"
    ],
    "쿠팡캐시 적립 서비스 제외 대상": [
        "쿠팡캐시적립서비스제외대상"
    ],
    "패밀리 레스토랑 할인": [
        "패밀리레스토랑할인"
    ],
    "포인트": [],
    "포인트 관련 세부사항": [
        "포인트관련세부사항"
    ],
    "포인트 적립 제외": [
        "포인트적립제외"
    ],
    "포인트리": [],
    "필수 생활비 적립 서비스": [
        "필수생활비적립서비스"
    ],
    "한도": [
        "limit",
        "상향",
        "얼마까지",
        "증액"
    ],
    "할부이자율 수수료율": [
        "할부이자율수수료율"
    ],
    "할인 공통 사항": [
        "할인공통사항"
    ],
    "할인 서비스 제외 대상": [
        "할인서비스제외대상"
    ],
    "해외 결제 적립": [
        "해외결제적립"
    ],
    "해외 이용 안내": [
        "해외이용안내"
    ],
    "해외 이용 확인사항": [
        "해외이용확인사항"
    ],
    "해외이용": [],
    "해외이용 확인사항": [
        "해외이용확인사항"
    ],
    "해지": [
        "없애",
        "없앨래",
        "해지",
        "제거"
    ],
    "환불 기부 안내": [
        "환불기부안내"
    ],
    "후불 교통기능 탑재": [
        "후불교통기능탑재"
    ],
    "휴대전화 알림 서비스 이용 수수료": [
        "휴대전화알림서비스이용수수료",
        "휴대폰알림",
    ]
}

# 단독으로는 의미가 약한 일반 의도
WEAK_INTENT_SYNONYMS = {
    "1차 지급 금액": [
        "1차지급금액"
    ],
    "2차 지급 금액": [
        "2차지급금액"
    ],
    "GS리테일 팝서비스": [
        "GS리테일팝서비스",
        "gs리테일 팝서비스"
    ],
    "경조사 서비스 제공": [
        "경조사서비스제공"
    ],
    "계약": [],
    "공통 확인사항": [
        "공통확인사항"
    ],
    "금감원 사칭 이메일 NOTICE 발령": [
        "금감원 사칭 이메일 notice 발령",
        "금감원사칭이메일NOTICE발령",
        "금감원"
    ],
    "금리인하요구권 안내": [
        "금리인하요구권안내",
        "금리인하"
    ],
    "금융사기 방지": [
        "금융사기방지",
        "금융사기"
    ],
    "금융소비자 보호제도 안내": [
        "금융소비자보호제도안내",
        "소비자 보호",
        "소비자 보호 제도"
    ],
    "금융소비자보호제도 안내": [
        "금융소비자보호제도안내"
    ],
    "금융안내": [],
    "단체보험 무료가입 및 사고 보장": [
        "단체보험무료가입및사고보장"
    ],
    "등급별 구분": [
        "등급별구분"
    ],
    "모든 서비스 공통 제외": [
        "모든서비스공통제외"
    ],
    "문자상담 서비스 종료 안내": [
        "문자상담서비스종료안내"
    ],
    "바로 혜택 알리미 서비스 종료 안내": [
        "바로혜택알리미서비스종료안내"
    ],
    "발급": [
        "발급 방법",
        "발급방법"
    ],
    "부가서비스 변경 안내": [
        "부가서비스변경안내"
    ],
    "부가서비스 변경안내": [
        "부가서비스변경안내"
    ],
    "사용": [
        "사용 방법",
        "사용방법",
        "사용법"
    ],
    "사용처": [
        "사용 가능한 곳",
        "어디서 사용"
    ],
    "상품 서비스": [
        "상품서비스"
    ],
    "상해보험": [],
    "서비스 유의사항": [
        "서비스유의사항"
    ],
    "숨은 금융자산 찾아주기 캠페인 안내": [
        "숨은금융자산찾아주기캠페인안내"
    ],
    "신용도": [],
    "신용카드업자에 따른 구분": [
        "신용카드업자에따른구분"
    ],
    "신청": [
        "신청 방법",
        "신청방법"
    ],
    "실적 유예기간 적용": [
        "실적유예기간적용"
    ],
    "아시아나항공 마일리지 전환 종료 안내": [
        "아시아나항공마일리지전환종료안내"
    ],
    "안내 및 구매 방법": [
        "안내및구매방법"
    ],
    "온라인상담 서비스 일시 중단 안내": [
        "온라인상담서비스일시중단안내"
    ],
    "용어 안내": [
        "용어안내"
    ],
    "이동의즐거움 실물카드 구입 방법 안내": [
        "이동의즐거움실물카드구입방법안내"
    ],
    "자주 묻는 질문": [
        "자주묻는질문"
    ],
    "제공 서비스별 구분": [
        "제공서비스별구분"
    ],
    "종류": [],
    "주소지 지자체 변경 방법": [
        "주소지지자체변경방법"
    ],
    "직불카드 체크카드 선불카드와의 구분": [
        "직불카드체크카드선불카드와의구분"
    ],
    "채팅상담 서비스 일시 중단 안내": [
        "채팅상담서비스일시중단안내"
    ],
    "추가정보": [],
    "카드 선택": [
        "카드선택"
    ],
    "카드사 별 실제 지급일과 지급방법": [
        "카드사별실제지급일과지급방법"
    ],
    "쿠팡캐시 안내": [
        "쿠팡캐시안내"
    ],
    "통신요금": [],
    "피해 예방과 대응": [
        "피해예방과대응"
    ],
    "할부철회권": [],
    "할부항변권": [],
    "해외로 가실 때는 IC카드를 챙기세요": [
        "해외로 가실 때는 ic카드를 챙기세요",
        "해외로가실때는IC카드를챙기세요"
    ],
    "현금서비스": [],
    "혜택": [],
    "홈페이지 침해사고 대응훈련": [
        "홈페이지침해사고대응훈련"
    ],
    "활용방법": [],
    "휴대전화번호 변경 방법": [
        "휴대전화번호변경방법"
    ]
}

ACTION_SYNONYMS.update({
    "사용 기간": [
        "사용기간",
        "언제까지",
        "언제 까지",
        "기한",
        "유효기간",
        "유효 기간",
        "마감",
        "마감일",
        "마감 일",
        "종료",
        "종료일",
        "종료 일",
        "까지 써",
        "까지 사용",
        "기간이 언제",
        "기간 언제",
        "언제 끝",
        "언제까지야",
        "언제까지에요",
        "언제까지예요",
        "언제까지 써요",
        "언제까지 사용해요",
        "언제까지 쓸 수",
        "언제까지 가능",
    ],
})

# 결제 수단 관련 키워드
PAYMENT_SYNONYMS = {
    "iM유페이": [
        "iM 유페이",
        "iM유 페이",
        "im유페이"
    ],
    "네이버페이": [
        "naver pay",
        "네이버 페이"
    ],
    "삼성페이": [
        "samsung pay",
        "삼성 페이"
    ],
    "애플페이": [
        "apple pay",
        "applepay",
        "애플 페이"
    ],
    "카카오페이": [
        "kakao pay",
        "카카오 페이"
    ],
    "티머니": [
        "t-money",
        "tmoney",
        "t머니",
        "티 머니"
    ]
}

# 라우팅 힌트용
ROUTE_CARD_INFO = "card_info"
ROUTE_CARD_USAGE = "card_usage"

# ACTION 중에서도 즉시 대응 가능한 intent만 허용
ACTION_ALLOWLIST = {"분실"}
PAYMENT_ALLOWLIST = set(PAYMENT_SYNONYMS.keys())

# 약한 의도 단독 등장 시 기본 라우팅 힌트
WEAK_INTENT_ROUTE_HINTS = {
    "혜택": ROUTE_CARD_INFO,
    "발급": ROUTE_CARD_USAGE,
    "신청": ROUTE_CARD_USAGE,
    "사용": ROUTE_CARD_USAGE,
    "사용처": ROUTE_CARD_USAGE,
}

STOPWORDS = {"n/a", "na", "none", "문의", "안내"}

# vocab.json 생성을 위한 그룹 정의
# - type: 키워드 분류
# - route: 기본 라우팅 대상 테이블
# - cooldown_sec: 동일 키워드 재트리거 방지 시간
# - synonyms: canonical ↔ synonym 매핑
# - filter_key: 검색 시 metadata filter에 사용
VOCAB_GROUPS = [
    {
        "type": "CARD/PROGRAM",
        "route": "card_tbl",
        "cooldown_sec": 8,
        "synonyms": CARD_NAME_SYNONYMS,
        "filter_key": "card_name",
    },
    {
        "type": "INTENT",
        "route": "guide_tbl",
        "cooldown_sec": 5,
        "synonyms": ACTION_SYNONYMS,
        "filter_key": "intent",
    },
    {
        "type": "WEAK_INTENT",
        "route": "guide_tbl",
        "cooldown_sec": 5,
        "synonyms": WEAK_INTENT_SYNONYMS,
        "filter_key": "weak_intent",
    },
    {
        "type": "PAYMENT",
        "route": "card_tbl",
        "cooldown_sec": 6,
        "synonyms": PAYMENT_SYNONYMS,
        "filter_key": "payment_method",
    },
]

import re

_WS_RE = re.compile(r"\s+")

def normalize_text(text: str) -> str:
    if not text:
        return ""
    return _WS_RE.sub(" ", text.strip().lower())

def expand_variants(terms: list[str]) -> list[str]:
    out = set()
    for t in terms:
        if not t:
            continue
        base = t.strip()
        out.add(base)
        out.add(base.lower())
        # 공백 제거/정규화
        out.add(re.sub(r"\s+", "", base))
        # 하이픈/중점 변형
        out.add(base.replace("-", " "))
        out.add(base.replace(" - ", "-"))
        out.add(base.replace("·", " "))
        out.add(base.replace("·", ""))
    return list(out)

def expand_synonym_map(syn_map: dict[str, list[str]]) -> dict[str, list[str]]:
    expanded = {}
    for canon, syns in syn_map.items():
        expanded[canon] = expand_variants([canon, *syns])
    return expanded


INTENT_PATTERNS = [
    # 사용 기간 / 유효기간
    ("사용 기간", re.compile(r"(언제\s*까지|기한|유효\s*기간|마감(일)?|종료(일)?|까지\s*(써|사용|가능)|언제\s*끝)", re.I)),

    # 신청/접수
    ("신청 방법 및 시간", re.compile(r"(신청|접수|등록)\s*(방법|어떻게|언제|기간|시간)|어떻게\s*신청|신청\s*언제", re.I)),

    # 사용처
    ("사용처", re.compile(r"(어디\s*서|어디서|사용\s*처|사용\s*가능|가능한\s*곳|가맹점|쓸\s*수\s*있)", re.I)),

    # 환불/취소
    ("환불", re.compile(r"(환불|반환|취소|철회|환급)", re.I)),
]

QUERY_EXPANSION = {
    "사용 기간": ["기간", "기한", "유효기간", "마감", "종료", "언제까지"],
    "신청 방법 및 시간": ["신청", "접수", "등록", "기간", "시간", "방법", "언제"],
    "사용처": ["사용처", "가맹점", "어디서", "사용 가능", "업종"],
    "분실": ["분실", "도난", "재발급", "사고신고", "정지", "없어졌", "잃어버렸"],
    "환불": ["환불", "취소", "반환", "환급"],
}

def build_reverse_index(syn_map: dict[str, list[str]]) -> dict[str, str]:
    """
    synonym -> canonical
    (주의) 충돌 시 먼저 들어온 canonical 우선
    """
    idx = {}
    for canon, syns in syn_map.items():
        for s in syns:
            s2 = normalize_text(s)
            if not s2:
                continue
            idx.setdefault(s2, canon)
    return idx

CARD_REV = build_reverse_index(CARD_NAME_SYNONYMS)
ACTION_REV = build_reverse_index(ACTION_SYNONYMS)
WEAK_REV = build_reverse_index(WEAK_INTENT_SYNONYMS)
PAY_REV = build_reverse_index(PAYMENT_SYNONYMS)

def find_best_by_substring(text_norm: str, rev: dict[str, str]) -> list[str]:
    """
    단순 포함 매칭: 긴 키워드 우선으로 여러 개 찾을 수 있게
    """
    hits = []
    for syn, canon in sorted(rev.items(), key=lambda x: -len(x[0])):
        if syn in STOPWORDS:
            continue
        if syn and syn in text_norm:
            hits.append(canon)
    # 중복 제거(순서 유지)
    uniq = []
    for h in hits:
        if h not in uniq:
            uniq.append(h)
    return uniq

def match_intent_by_pattern(text: str) -> list[str]:
    hits = []
    for canon, pat in INTENT_PATTERNS:
        if pat.search(text):
            hits.append(canon)
    return hits

def match_query(text: str) -> dict:
    raw = text or ""
    t = normalize_text(raw)

    cards = find_best_by_substring(t, CARD_REV)
    payments = find_best_by_substring(t, PAY_REV)

    # intent는 (1) 패턴 → (2) 동의어 포함 순으로
    intents = match_intent_by_pattern(raw)
    intents2 = find_best_by_substring(t, ACTION_REV)
    for x in intents2:
        if x not in intents:
            intents.append(x)

    weak = find_best_by_substring(t, WEAK_REV)

    # 검색 확장 쿼리 만들기
    expansions = []
    for it in intents[:2]:
        expansions += QUERY_EXPANSION.get(it, [])
    for c in cards[:2]:
        # 카드/프로그램명은 그대로 확장에 포함
        expansions.append(c)
    expansions = list(dict.fromkeys(expansions))  # unique preserve

    # route 힌트: 카드명 있으면 card_tbl 우선, intent면 guide_tbl 우선
    route_hint = None
    if cards:
        route_hint = "card_tbl"
    elif intents:
        route_hint = "guide_tbl"
    elif weak:
        # 약한 의도 힌트
        for w in weak:
            if w in WEAK_INTENT_ROUTE_HINTS:
                route_hint = WEAK_INTENT_ROUTE_HINTS[w]
                break

    return {
        "text": raw,
        "normalized": t,
        "card_names": cards,
        "payments": payments,
        "intents": intents,
        "weak_intents": weak,
        "route_hint": route_hint,
        "expanded_query_terms": expansions,
    }
