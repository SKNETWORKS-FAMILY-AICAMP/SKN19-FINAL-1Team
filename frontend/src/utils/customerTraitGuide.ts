/**
 * ê³ ê° íŠ¹ì„± íƒœê·¸ ê¸°ë°˜ ìƒë‹´ ê°€ì´ë“œ ìœ í‹¸ë¦¬í‹°
 * â­ Phase 9: LLM ê¸°ë°˜ ê³ ê° ë§ì¶¤í˜• ìƒë‹´ ê°€ì´ë“œ ìƒì„±
 */

import type { CustomerInfo } from '../data/scenarios';

/**
 * ì˜ì–´ personalityTags â†’ í•œê¸€ ë³€í™˜ ë§¤í•‘
 * DBì— ì˜ì–´ë¡œ ì €ì¥ëœ íƒœê·¸ë¥¼ í•œê¸€ë¡œ í‘œì‹œ
 */
const PERSONALITY_TAG_MAP: { [key: string]: string } = {
  // ì„±ê²©/ì„±í–¥
  'impatient': 'ì„±ê¸‰í•¨',
  'emotional': 'ê°ì •ì ',
  'calm': 'ì°¨ë¶„í•¨',
  'friendly': 'ì¹œì ˆí•¨',
  'aggressive': 'ê³µê²©ì ',
  'passive': 'ìˆ˜ë™ì ',
  'analytical': 'ë¶„ì„ì ',
  'expressive': 'í‘œí˜„ì ',
  'assertive': 'ì ê·¹ì ',
  'reserved': 'ë‚´ì„±ì ',
  'talkative': 'ìˆ˜ë‹¤í˜•',
  'personal': 'ì¹œë°€í˜•',
  'quiet': 'ì¡°ìš©í•¨',
  'polite': 'ì˜ˆì˜ë°”ë¦„',
  'direct': 'ì§ì ‘ì ',
  'indirect': 'ìš°íšŒì ',
  'patient': 'ì¸ë‚´ì‹¬',
  'anxious': 'ë¶ˆì•ˆí•¨',
  'confident': 'ìì‹ ê°',
  'hesitant': 'ë§ì„¤ì„',

  // ìƒë‹´ ìŠ¤íƒ€ì¼
  'quick_response': 'ë¹ ë¥¸ ë‹µë³€ ì„ í˜¸',
  'detailed_explanation': 'ìƒì„¸ ì„¤ëª… í•„ìš”',
  'empathy_needed': 'ê³µê° í•„ìš”',
  'repeat_explanation': 'ë°˜ë³µ ì„¤ëª… í•„ìš”',
  'self_service': 'ì…€í”„ì„œë¹„ìŠ¤ ì„ í˜¸',
  'digital_native': 'ë””ì§€í„¸ ì¹œí™”',
  'tech_savvy': 'ê¸°ìˆ  ì¹œí™”ì ',
  'needs_empathy': 'ê³µê° í•„ìš”',
  'detail_oriented': 'ê¼¼ê¼¼í•¨',

  // ê³ ê° ìœ í˜•
  'vip': 'VIP ê³ ê°',
  'premium': 'í”„ë¦¬ë¯¸ì—„ ê³ ê°',
  'loyal': 'ì¶©ì„± ê³ ê°',
  'new_customer': 'ì‹ ê·œ ê³ ê°',
  'senior': 'ì‹œë‹ˆì–´',
  'business': 'ë¹„ì¦ˆë‹ˆìŠ¤ ê³ ê°',
  'regular': 'ì¼ë°˜ ê³ ê°',

  // ì£¼ì˜ í•„ìš”
  'complaint_prone': 'ë¯¼ì› ì´ë ¥',
  'delinquent': 'ì—°ì²´ ì´ë ¥',
  'cost_sensitive': 'ë¹„ìš© ë¯¼ê°',
  'high_maintenance': 'ìš”êµ¬ì‚¬í•­ ë§ìŒ',
  'sensitive': 'ë¯¼ê°í•¨',
  'urgent': 'ê¸´ê¸‰',
  'time_sensitive': 'ì‹œê°„ ë¯¼ê°',
  'rushed': 'ê¸‰í•¨',
  'busy': 'ë°”ì¨',
};

/**
 * ì˜ì–´ íƒœê·¸ë¥¼ í•œê¸€ë¡œ ë³€í™˜
 */
export function translatePersonalityTag(tag: string): string {
  // ì´ë¯¸ í•œê¸€ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
  if (/[ê°€-í£]/.test(tag)) {
    return tag;
  }
  // ë§¤í•‘ëœ í•œê¸€ì´ ìˆìœ¼ë©´ ë°˜í™˜, ì—†ìœ¼ë©´ ì›ë³¸
  return PERSONALITY_TAG_MAP[tag.toLowerCase()] || tag;
}

/**
 * ê³ ê° íŠ¹ì„± íƒœê·¸ ìƒ‰ìƒ ë§¤í•‘ (UI ë°°ì§€ìš©)
 * â­ Phase 10: 12ê°œ í˜ë¥´ì†Œë‚˜ íŠ¹ì„± ì¶”ê°€ + ë¸”ë£¨ ê³„ì—´ í†µì¼
 */
export function getTraitColor(trait: string): { bg: string; text: string } {
  const colorMap: { [key: string]: { bg: string; text: string } } = {
    // ë“±ê¸‰ë³„ í…Œë§ˆ ìƒ‰ìƒ (ì§§ì€ í˜•ì‹)
    'VIP': { bg: '#FDF4E7', text: '#B8860B' },          // ê³¨ë“œ ê³„ì—´
    'GOLD': { bg: '#FDF4E7', text: '#B8860B' },         // ê³¨ë“œ ê³„ì—´
    'PREMIUM': { bg: '#F3E8FF', text: '#7C3AED' },      // í¼í”Œ ê³„ì—´
    'SILVER': { bg: '#F1F5F9', text: '#475569' },       // ì‹¤ë²„ ê³„ì—´
    'GENERAL': { bg: '#F5F5F5', text: '#666666' },      // ì¼ë°˜ ê·¸ë ˆì´
    'ì¼ë°˜': { bg: '#F5F5F5', text: '#666666' },         // ì¼ë°˜ ê·¸ë ˆì´
    // ë“±ê¸‰ë³„ í…Œë§ˆ ìƒ‰ìƒ (ê¸´ í˜•ì‹ - í˜¸í™˜ìš©)
    'VIP ë“±ê¸‰': { bg: '#FDF4E7', text: '#B8860B' },
    'GOLD ë“±ê¸‰': { bg: '#FDF4E7', text: '#B8860B' },
    'PREMIUM ë“±ê¸‰': { bg: '#F3E8FF', text: '#7C3AED' },
    'SILVER ë“±ê¸‰': { bg: '#F1F5F9', text: '#475569' },
    'GENERAL ë“±ê¸‰': { bg: '#F5F5F5', text: '#666666' },

    // ê¸ì •ì  íŠ¹ì„± - ì§„í•œ ë¸”ë£¨
    'VIP ê³ ê°': { bg: '#FDF4E7', text: '#B8860B' },
    'ì‹ ìš© ê´€ë¦¬ ì² ì €': { bg: '#E8F1FC', text: '#0047AB' },
    'ê³„íšì ì¸ ì„±í–¥': { bg: '#E8F1FC', text: '#0047AB' },
    'ê¸°ìˆ  ì¹œí™”ì ': { bg: '#E8F1FC', text: '#0047AB' },
    'ë¹„ì¦ˆë‹ˆìŠ¤ ëª©ì ': { bg: '#E8F1FC', text: '#0047AB' },
    'í”„ë¡œì„¸ìŠ¤ ì´í•´ë„ ë†’ìŒ': { bg: '#E8F1FC', text: '#0047AB' },
    'ê²°ê³¼ ì¤‘ì‹¬': { bg: '#E8F1FC', text: '#0047AB' },
    'ìë™í™” ì„ í˜¸': { bg: '#E8F1FC', text: '#0047AB' },
    'ì ê·¹ì ì¸ ì§ˆë¬¸': { bg: '#E8F1FC', text: '#0047AB' },
    'í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ ê¸°ëŒ€': { bg: '#E8F1FC', text: '#0047AB' },
    'ì¶©ì„± ê³ ê°': { bg: '#E8F1FC', text: '#0047AB' },
    'ë””ì§€í„¸ ë„¤ì´í‹°ë¸Œ': { bg: '#E8F1FC', text: '#0047AB' },
    'ì…€í”„ì„œë¹„ìŠ¤ ì„ í˜¸': { bg: '#E8F1FC', text: '#0047AB' },
    
    // ì¤‘ë¦½ì  íŠ¹ì„± - ê·¸ë ˆì´
    'ì¼ë°˜ ê³ ê°': { bg: '#F5F5F5', text: '#666666' },
    'ì¹œì ˆí•œ ì„±í–¥': { bg: '#F5F5F5', text: '#666666' },
    'ì¡°ìš©í•œ ì„±í–¥': { bg: '#F5F5F5', text: '#666666' },
    'ë‚´ì„±ì ': { bg: '#F5F5F5', text: '#666666' },
    'ì‹¤ìš©ì£¼ì˜': { bg: '#F5F5F5', text: '#666666' },
    'íš¨ìœ¨ ì¤‘ì‹œ': { bg: '#F5F5F5', text: '#666666' },
    'ëª©ì  ì§€í–¥ì ': { bg: '#F5F5F5', text: '#666666' },
    'ì¹œí™”ì ': { bg: '#F5F5F5', text: '#666666' },
    'ìˆ˜ë‹¤í˜•': { bg: '#E8F4FD', text: '#1976D2' },
    'ì¹œë°€í˜•': { bg: '#E8F4FD', text: '#1976D2' },
    'ëŒ€í™” ì„ í˜¸': { bg: '#F5F5F5', text: '#666666' },
    'ì¡°ìš©í•¨': { bg: '#F5F5F5', text: '#666666' },
    'ì˜ˆì˜ë°”ë¦„': { bg: '#E8F1FC', text: '#0047AB' },
    'ì¸ë‚´ì‹¬': { bg: '#E8F1FC', text: '#0047AB' },
    'ìì‹ ê°': { bg: '#E8F1FC', text: '#0047AB' },
    'ê¼¼ê¼¼í•¨': { bg: '#F5F5F5', text: '#666666' },
    'ë¹ ë¥¸ ë‹µë³€ ì„ í˜¸': { bg: '#F5F5F5', text: '#666666' },
    'ë°”ì¨': { bg: '#F5F5F5', text: '#666666' },
    'ìƒì„¸í•œ ì„¤ëª… í•„ìš”': { bg: '#F5F5F5', text: '#666666' },
    'ìƒì„¸í•œ ì„¤ëª… ìš”êµ¬': { bg: '#F5F5F5', text: '#666666' },
    'ë¶„ì„ì ': { bg: '#F5F5F5', text: '#666666' },
    'í‘œí˜„ì ': { bg: '#F5F5F5', text: '#666666' },
    'ì‹œë‹ˆì–´': { bg: '#F5F5F5', text: '#666666' },
    'ì²œì²œíˆ ì„¤ëª… í•„ìš”': { bg: '#F5F5F5', text: '#666666' },
    'ë°˜ë³µ ì•ˆë‚´ í•„ìš”': { bg: '#F5F5F5', text: '#666666' },
    'í•´ì™¸ ê±°ì£¼': { bg: '#F5F5F5', text: '#666666' },
    'í•´ì™¸ ì¶œì¥ ì¦ìŒ': { bg: '#F5F5F5', text: '#666666' },
    'ë¹„ìš© ë¯¼ê°': { bg: '#F5F5F5', text: '#666666' },
    'ê¼¼ê¼¼í•œ ì„±í–¥': { bg: '#F5F5F5', text: '#666666' },
    'ë°˜ë³µ ì§ˆë¬¸ ë§ìŒ': { bg: '#F5F5F5', text: '#666666' },
    'ì˜ì–´ ê°€ëŠ¥': { bg: '#F5F5F5', text: '#666666' },
    'ì˜¨ë¼ì¸ ì²˜ë¦¬ ì„ í˜¸': { bg: '#F5F5F5', text: '#666666' },
    'ê¸‰ì—¬ì¼ ê¸°ë°˜ ê´€ë¦¬': { bg: '#F5F5F5', text: '#666666' },
    'ì´ì „ ì´ë ¥ í™•ì¸ í•„ìš”': { bg: '#F5F5F5', text: '#666666' },
    'ìš”êµ¬ì‚¬í•­ ë§ìŒ': { bg: '#F5F5F5', text: '#666666' },
    'ê¹Œë‹¤ë¡œì›€': { bg: '#F5F5F5', text: '#666666' },
    
    // ì£¼ì˜ í•„ìš” íŠ¹ì„± - ì—°í•œ ë¸”ë£¨ (ê²½ê³ ì„±ì´ì§€ë§Œ ë¶€ë“œëŸ½ê²Œ)
    'ê¸‰í•œ ì„±í–¥': { bg: '#D4E3F3', text: '#003580' },
    'ê°ì • ê¸°ë³µ ìˆìŒ': { bg: '#D4E3F3', text: '#003580' },
    'ê²½ì œì  ì–´ë ¤ì›€': { bg: '#D4E3F3', text: '#003580' },
    'ë°˜ë³µ ì—°ì²´ ì´ë ¥': { bg: '#D4E3F3', text: '#003580' },
    'ê³µê° í•„ìš”': { bg: '#D4E3F3', text: '#003580' },
    'ê°ì • í˜¸ì†Œí˜•': { bg: '#D4E3F3', text: '#003580' },
    'ë°˜ë³µ ë¯¼ì›': { bg: '#D4E3F3', text: '#003580' },
    'ì¢Œì ˆê°': { bg: '#D4E3F3', text: '#003580' },
    'ë¶ˆë§Œ í•­ì˜': { bg: '#D4E3F3', text: '#003580' },
    'ê¸´ê¸‰': { bg: '#FEE2E2', text: '#DC2626' },         // ë¹¨ê°„ìƒ‰ ê³„ì—´
    'ì‹œê°„ ë¯¼ê°': { bg: '#FEF3C7', text: '#D97706' },    // ì£¼í™©ìƒ‰ ê³„ì—´
    'ê¸‰í•¨': { bg: '#FEE2E2', text: '#DC2626' },
    'ë¯¼ê°í•¨': { bg: '#D4E3F3', text: '#003580' },
    'ë¶ˆì•ˆí•¨': { bg: '#D4E3F3', text: '#003580' },
    'ë§ì„¤ì„': { bg: '#F5F5F5', text: '#666666' },
  };

  return colorMap[trait] || { bg: '#F5F5F5', text: '#999999' };  // ê¸°ë³¸ê°’
}

/**
 * ê³ ê° íŠ¹ì„± íƒœê·¸ ì•„ì´ì½˜ ë§¤í•‘ (ì„ íƒ)
 * â­ Phase 9-2: ì•„ì´ì½˜ ì œê±°ë¡œ ì¸í•´ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (í–¥í›„ ì‚­ì œ ê°€ëŠ¥)
 */
export function getTraitIcon(trait: string): string {
  return '';  // ì•„ì´ì½˜ ì œê±°
}

/**
 * ê³ ê° íŠ¹ì„± ìš”ì•½ ë¬¸êµ¬ ìƒì„±
 * 
 * @param customer - ê³ ê° ì •ë³´
 * @returns ê°„ê²°í•œ íŠ¹ì„± ìš”ì•½
 */
export function getCustomerTraitSummary(customer: CustomerInfo): string {
  if (!customer.traits || customer.traits.length === 0) {
    return 'ì¼ë°˜ì ì¸';
  }

  // ì£¼ìš” íŠ¹ì„± 1-2ê°œë§Œ ì¶”ì¶œ
  const keyTraits = customer.traits.slice(0, 2);
  return keyTraits.join(', ');
}

/**
 * ê³ ê° íŠ¹ì„± íƒœê·¸ ê¸°ë°˜ ìƒë‹´ ê°€ì´ë“œ ìƒì„±
 * 
 * @param customer - ê³ ê° ì •ë³´ (traits, age, preferredStyle í¬í•¨)
 * @returns ìƒë‹´ ê°€ì´ë“œ ë¬¸êµ¬
 */
export function generateCustomerGuide(customer: CustomerInfo): string {
  if (!customer.traits || customer.traits.length === 0) {
    return `${customer.name} ê³ ê°ë‹˜ê³¼ì˜ ìƒë‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤. ê¸°ë³¸ ì‘ëŒ€ ë§¤ë‰´ì–¼ì— ë”°ë¼ ì§„í–‰í•´ì£¼ì„¸ìš”.`;
  }

  // â­ Mock LLM: íƒœê·¸ ê¸°ë°˜ ê°€ì´ë“œ ìƒì„± ë¡œì§
  const traits = customer.traits;
  const age = customer.age || null;
  const style = customer.preferredStyle || '';

  // 1. ì¸ì‚¬ë§
  let guide = `ğŸ’¡ ${customer.name} ê³ ê°ë‹˜ ìƒë‹´ ê°€ì´ë“œ\n\n`;

  // 2. ê³ ê° íŠ¹ì„± ìš”ì•½
  guide += `ğŸ·ï¸ ê³ ê° íŠ¹ì„±:\n`;
  traits.forEach((trait, index) => {
    guide += `  ${index + 1}. ${trait}\n`;
  });
  if (age) {
    guide += `  â€¢ ì—°ë ¹ëŒ€: ${age}ì„¸\n`;
  }
  guide += `\n`;

  // 3. ì¶”ì²œ ìƒë‹´ ë°©ì‹
  guide += `ğŸ“Œ ì¶”ì²œ ìƒë‹´ ë°©ì‹:\n`;
  
  // íŠ¹ì„±ë³„ ìƒë‹´ íŒ
  if (traits.includes('ë¹ ë¥¸ ë‹µë³€ ì„ í˜¸') || traits.includes('ê¸‰í•œ ì„±í–¥')) {
    guide += `  â€¢ í•µì‹¬ ì •ë³´ë¥¼ ë¨¼ì € ì „ë‹¬í•˜ê³ , ì„¸ë¶€ì‚¬í•­ì€ í•„ìš”ì‹œ ì¶”ê°€ ì„¤ëª…\n`;
    guide += `  â€¢ ë¶ˆí•„ìš”í•œ ì¸ì‚¬ë§ì´ë‚˜ ì „ì¹˜ì‚¬ë¥¼ ìµœì†Œí™”\n`;
  }
  
  if (traits.includes('VIP ê³ ê°') || traits.includes('PREMIUM') || traits.includes('GOLD')) {
    guide += `  â€¢ VIP ì „ìš© í˜œíƒ ë° ìš°ì„  ì²˜ë¦¬ ì˜µì…˜ ì•ˆë‚´\n`;
    guide += `  â€¢ ë‹´ë‹¹ ë§¤ë‹ˆì € ì—°ê²° ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸\n`;
  }
  
  if (traits.includes('í•´ì™¸ ê±°ì£¼') || traits.includes('í•´ì™¸ ì¶œì¥ ì¦ìŒ')) {
    guide += `  â€¢ ì‹œì°¨ë¥¼ ê³ ë ¤í•œ ì‘ëŒ€ (í˜„ì¬ í˜„ì§€ ì‹œê°„ í™•ì¸)\n`;
    guide += `  â€¢ í•´ì™¸ ì—°ë½ì²˜ í™•ì¸ ë° êµ­ì œ ì „í™” ì•ˆë‚´\n`;
  }
  
  if (traits.includes('ê°ì • ê¸°ë³µ ìˆìŒ') || traits.includes('ê³µê° í•„ìš”')) {
    guide += `  â€¢ ê³µê° í‘œí˜„ì„ ìì£¼ ì‚¬ìš© ("ê³ ê°ë‹˜ ë§ì”€ ì¶©ë¶„íˆ ì´í•´ë©ë‹ˆë‹¤")\n`;
    guide += `  â€¢ ì°¨ë¶„í•œ í†¤ìœ¼ë¡œ ì•ˆì •ê° ì œê³µ\n`;
  }
  
  if (traits.includes('ìƒì„¸í•œ ì„¤ëª… í•„ìš”') || traits.includes('ê¼¼ê¼¼í•œ ì„±í–¥')) {
    guide += `  â€¢ ë‹¨ê³„ë³„ ì„¤ëª…ê³¼ êµ¬ì²´ì ì¸ ì˜ˆì‹œ ì œê³µ\n`;
    guide += `  â€¢ ì„œë©´ ìë£Œ(ì´ë©”ì¼/SMS) ë°œì†¡ ì œì•ˆ\n`;
  }
  
  if (traits.includes('ë¹„ìš© ë¯¼ê°') || traits.includes('ê²½ì œì  ì–´ë ¤ì›€')) {
    guide += `  â€¢ ìˆ˜ìˆ˜ë£Œ ë©´ì œ/í• ì¸ í˜œíƒ ì ê·¹ ì•ˆë‚´\n`;
    guide += `  â€¢ ë¬´ì´ì í• ë¶€, ë¦¬ë³¼ë¹™ ë“± ëŒ€ì•ˆ ì œì‹œ\n`;
  }

  if (traits.includes('ê¸°ìˆ  ì¹œí™”ì ') || traits.includes('ì˜¨ë¼ì¸ ì²˜ë¦¬ ì„ í˜¸') || traits.includes('ìë™í™” ì„ í˜¸')) {
    guide += `  â€¢ ì•±/ì›¹ ì…€í”„ì„œë¹„ìŠ¤ ì ê·¹ ì•ˆë‚´\n`;
    guide += `  â€¢ ìë™í™”ëœ í”„ë¡œì„¸ìŠ¤(ìë™ì´ì²´, ì•Œë¦¼ ì„¤ì • ë“±) ì¶”ì²œ\n`;
  }

  // 4. ì„ í˜¸ ìŠ¤íƒ€ì¼ (ìˆì„ ê²½ìš°)
  if (style) {
    guide += `\nâœ¨ ì´ ê³ ê°ë‹˜ì€:\n`;
    guide += `  "${style}"\n`;
  }

  // 5. ë§ˆë¬´ë¦¬ íŒ
  guide += `\nğŸ’¬ ì¶”ê°€ íŒ:\n`;
  guide += `  â€¢ ìƒë‹´ ì¢…ë£Œ ì‹œ "ë˜ ê¶ê¸ˆí•˜ì‹  ì  ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”" ì•ˆë‚´\n`;
  guide += `  â€¢ ì´ë²ˆ ìƒë‹´ì—ì„œ ìƒˆë¡œìš´ íŠ¹ì„± ë°œê²¬ ì‹œ í›„ì²˜ë¦¬ ë©”ëª¨ì— ê¸°ë¡\n`;

  return guide;
}
